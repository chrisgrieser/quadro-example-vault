/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var B=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var be=Object.getOwnPropertyNames;var Ae=Object.prototype.hasOwnProperty;var Re=(t,e)=>{for(var n in e)B(t,n,{get:e[n],enumerable:!0})},ke=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of be(e))!Ae.call(t,i)&&i!==n&&B(t,i,{get:()=>e[i],enumerable:!(o=Ie(e,i))||o.enumerable});return t};var De=t=>ke(B({},"__esModule",{value:!0}),t);var $e={};Re($e,{default:()=>N});module.exports=De($e);var Fe=require("obsidian");var x=require("obsidian");function Se(t){return Math.ceil(Math.random()*10**t).toString().padStart(t,"0")}var Oe=/\^[\w-]+(?=\n|$)/g,_=/\^[\w-]+$/,J=/^!\[\[(.+?)#(\^[\w-]+)\]\]$/;async function S(t,e){let[n]=e.match(_)||[];if(n){let s=e.slice(0,-n.length).trim();return{blockId:n,lineWithoutId:s}}let i=(await t.vault.cachedRead(t)).match(Oe)||[],a;do a="^id-"+Se(6);while(i.includes(a));return{blockId:a,lineWithoutId:e.trim()}}var u="Codes",Z={char:"\u{1FB0B}",charsPerBlock:100,maxLength:100},Le={alphabeticalByCodeName:(t,e)=>t.basename.localeCompare(e.basename),alphabeticalByFullCode:(t,e)=>{let n=t.path.slice(u.length+1),o=e.path.slice(u.length+1);return n.localeCompare(o)},lastUsedFirst:(t,e)=>e.stat.mtime-t.stat.mtime,oldestUsedFirst:(t,e)=>t.stat.mtime-e.stat.mtime,frequentlyUsedFirst:(t,e)=>e.stat.size-t.stat.size,rarelyUsedFirst:(t,e)=>t.stat.size-e.stat.size,randomOrder:()=>Math.random()-.5},ee=Le.lastUsedFirst,f="Extractions",M="Analysis";var b=require("obsidian");function h(t,e){let n=e==="Codes"?u:f,o=t.workspace.getActiveFile();return o?!!o.path.startsWith(n+"/"):!1}function A(t){return t.path.slice(u.length+1,-3)}function T(t){let e=t.workspace.getActiveViewOfType(b.MarkdownView);return e?e.editor:(new b.Notice("No active editor."),null)}var w=[{command:"\u2191\u2193",purpose:"Navigate"},{command:"\u23CE",purpose:"Select"},{command:"esc",purpose:"Dismiss"}];function O(t){let e=`.workspace-leaf.mod-active .metadata-property:first-of-type .metadata-property-${t} :is([contenteditable='true'], input)`,n=document.querySelector(e);n instanceof HTMLElement&&Pe(n,0),n instanceof HTMLInputElement&&n.select()}function Pe(t,e){if(t instanceof HTMLInputElement){t.focus();let n=t.getAttribute("type")==="number";n&&t.setAttribute("type","text"),t.setSelectionRange(e,e),n&&t.setAttribute("type","number")}else{let n=document.createRange(),o=window.getSelection();n.setStart(t,e),n.collapse(!0),o?.removeAllRanges(),o?.addRange(n)}}var G={state:{source:!1,mode:"source"}};async function R(t,e){let n=t.workspace.getLeaf();await(t.workspace.getAdjacentLeafInDirection(n,"right")||t.workspace.createLeafBySplit(n,"vertical",!1)).openFile(e,G)}function I(t){let e=t.getCursor("head").line!==t.getCursor("anchor").line,n=t.listSelections().length>1;return e||n?(new b.Notice(`Paragraph not unambiguous since multiple lines are selected.

Unselect, move your cursor to the paragraph you want to affect, and use the command again.`,5e3),!0):!1}var m=require("obsidian");var W=class extends m.Modal{constructor(n,o){super(n);this.fullCode="";this.codeDesc="";this.confirmationButton=null;this.onSubmit=o,this.modalEl.addClass("quadro")}onOpen(){let{contentEl:n}=this;n.createEl("h4",{text:"New code creation"}),new m.Setting(n).setName("Name of the Code").setDesc('Use a slash ("/") in the name to create the Code File in a subfolder (group).').addText(o=>o.onChange(i=>{this.fullCode=i.trim(),this.confirmationButton?.setDisabled(this.fullCode==="")})),new m.Setting(n).setName("Code Description").setDesc('Will be added as metadata with the key "description".').addText(o=>o.onChange(i=>{this.codeDesc=i.trim()})),new m.Setting(n).addButton(o=>{this.confirmationButton=o.setButtonText("Create").setCta().setDisabled(!0).onClick(()=>{this.close(),this.onSubmit(this.fullCode,this.codeDesc)})}).addButton(o=>o.setButtonText("Cancel").onClick(()=>this.close()))}onClose(){let{contentEl:n}=this;n.empty()}},U=class extends m.Modal{constructor(n,o){super(n);this.input="";this.confirmationButton=null;this.onSubmit=o,this.modalEl.addClass("quadro")}onOpen(){let{contentEl:n}=this;n.createEl("h4",{text:"Bulk-create new codes"}),n.createEl("p",{text:"Every line will result in a new code file."}),n.createEl("p",{text:'Use a slash ("/") in the name to create the Code File in a subfolder (group).'}),new m.Setting(n).setClass("quadro-bulk-code-creation").addTextArea(o=>o.onChange(i=>{this.input=i.trim(),this.confirmationButton?.setDisabled(this.input==="")})),new m.Setting(n).addButton(o=>{this.confirmationButton=o.setButtonText("Create").setCta().setDisabled(!0).onClick(()=>{this.close(),this.onSubmit(this.input)})}).addButton(o=>o.setButtonText("Cancel").onClick(()=>this.close()))}onClose(){let{contentEl:n}=this;n.empty()}};async function te(t,e,n){e=e.replace(/\.md$/,"").replace(/[:#^?!"*<>|[\]\\]/g,"-").replace(/^\.|\/\./g,"");let o=(0,m.normalizePath)(`${u}/${e}.md`);if(t.vault.getAbstractFileByPath(o)instanceof m.TFile)return new m.Notice(`Code "${e}" already exists, Code File not created.`),!1;let a=e.split("/"),s=a.pop(),l=a.length?"/"+a.join("/"):"",r=u+l;t.vault.getFolderByPath(r)||await t.vault.createFolder(r),n=n.replaceAll('"',"'");let d=`---
description: "${n}"
---


---

`;return await t.vault.create(`${r}/${s}.md`,d)}function ne(t,e){new W(t,async(n,o)=>{let i=await te(t,n,o);i?(new m.Notice(`Created new code file: "${n}"`),e(i)):new m.Notice("File creation failed.")}).open()}async function oe(t){new U(t,async e=>{let n=0,o=[];for(let a of e.split(`
`))await te(t,a,"")?n++:o.push(a);let i=`${n} file(s) created`;o.length>0&&(i+=`
Could not create: `+o.join(", ")),new m.Notice(i,(o.length+2)*1e3)}).open()}var z=class extends x.FuzzySuggestModal{constructor(e,n,o,i){super(e),this.editor=n,this.codesInPara=o,this.dataFile=i,this.setPlaceholder("Select code to assign"),this.setInstructions([...w,{command:'type "new"',purpose:"Create new code"}]),this.modalEl.addClass("quadro")}getItems(){let e=this.app.vault.getMarkdownFiles().filter(n=>{let o=n.path.startsWith(u+"/"),i=this.codesInPara.find(a=>a.path===n.path);return o&&!i}).sort(ee);return e.push("new-code-file"),e}getItemText(e){if(e==="new-code-file")return"\u{1F79C} Create new code";let{char:n,charsPerBlock:o,maxLength:i}=Z,a="    "+n.repeat(Math.min(i,e.stat.size/o));return A(e)+a}onChooseItem(e){e instanceof x.TFile?this.assignCode(e,this.dataFile):ne(this.app,n=>this.assignCode(n,this.dataFile))}async assignCode(e,n){let o=this.editor.getCursor(),i=A(e),a=this.editor.getLine(o.line),s=this.editor.getSelection();if(s){let y=s.replace(/^( ?)(.+?)( ?)$/g,"$1==$2==$3");this.editor.replaceSelection(y),a=this.editor.getLine(o.line)}let{blockId:l,lineWithoutId:r}=await S(n,a),c=`${r} [[${i}]] ${l}`;this.editor.setLine(o.line,c),this.editor.setCursor(o);let p=`![[${n.path.slice(0,-3)}#${l}]]
`;await this.app.vault.append(e,p)}};function ie(t){let e=T(t);if(!e||I(e))return;if(h(t,"Codes")||h(t,"Extractions")){new x.Notice("You must be in a Data File to assign a code.",3e3);return}if(e.getSelection().includes("==")){new x.Notice(`Selection contains highlights.
Overlapping highlights are not supported.`);return}let o=e.editorComponent.view.file,s=(e.getLine(e.getCursor().line).match(/\[\[.+?\]\]/g)||[]).reduce((l,r)=>{r=r.slice(2,-2);let c=t.metadataCache.getFirstLinkpathDest(r,o.path);return c instanceof x.TFile&&c.path.startsWith(u+"/")&&l.push(c),l},[]);new z(t,e,s,o).open()}var v=require("obsidian");var g=require("obsidian");var j=class extends g.FuzzySuggestModal{constructor(e,n,o,i){super(e),this.codesInParagraph=i,this.dataFile=o,this.editor=n,this.setPlaceholder("Select code to remove from paragraph"),this.setInstructions(w),this.modalEl.addClass("quadro")}getItems(){return this.codesInParagraph}getItemText(e){return A(e.tFile)}onChooseItem(e){ae(this.editor,this.dataFile,e)}};async function q(t,e,n,o){let i=(await t.vault.read(n)).split(`
`),a=i.findIndex(c=>c.endsWith(o));if(a<0)return`Data File "${n.basename}", has no line with the ID "${o}".`;let s=i[a]||"",r=(s.match(/\[\[.+?\]\]/g)||[]).find(c=>{c=c.slice(2,-2);let d=t.metadataCache.getFirstLinkpathDest(c,n.path);return d instanceof g.TFile&&d.path===e.path});return r?(i[a]=s.replace(r,"").replace(/ {2,}/g," "),await t.vault.modify(n,i.join(`
`)),""):`Data File "${n.basename}", line "${o}" has no valid link to the Code File.`}async function ae(t,e,n){let o=t.editorComponent.app,i=t.getCursor().line,a=t.getLine(i),s=new RegExp(" ?\\[\\["+n.wikilink+"\\]\\]");t.setLine(i,a.replace(s,""));let[l]=a.match(_)||[];if(!l){new g.Notice(`No ID found in current line.
Reference in Code File thus not deleted.`);return}let r=(await o.vault.read(n.tFile)).split(`
`),c=r.findIndex(d=>{if(!d.includes(l))return!1;let p=d.match(/\[\[.+?\]\]/g)||[];for(let y of p){let $=y.slice(2,-2).split("#")[0]||"";if(o.metadataCache.getFirstLinkpathDest($,n.tFile.path)?.path===e.path)return!0}return!1});if(c<0){new g.Notice(`"Code File "${n.tFile.basename}" contains not reference to Data File "${e.basename}" with the ID "${l}". Reference in Code File is thus not deleted.`,7e3);return}r.splice(c,1),await o.vault.modify(n.tFile,r.join(`
`)),new g.Notice(`Assignment of code "${n.tFile.basename}" removed.`)}async function Ne(t,e){let n=e.getLine(e.getCursor().line),[o,i,a]=n.match(J)||[],s=e.editorComponent.view.file,l=t.metadataCache.getFirstLinkpathDest(i||"",s.path);if(!a||!i||!l){new g.Notice("Current line has no correct reference.");return}let r=await q(t,s,l,a);if(r){new g.Notice(r+`

Aborting removal of Code.`,4e3);return}t.commands.executeCommandById("editor:delete-paragraph"),e.setCursor({line:e.getCursor().line,ch:0}),new g.Notice(`Assignment of code "${s.basename}" removed.`)}async function re(t){let e=T(t);if(!(!e||I(e)))if(h(t,"Codes"))Ne(t,e);else{let n=e.editorComponent.view.file,a=(e.getLine(e.getCursor().line).match(/\[\[.+?\]\]/g)||[]).reduce((s,l)=>{l=l.slice(2,-2);let r=t.metadataCache.getFirstLinkpathDest(l,n.path);return r instanceof g.TFile&&r.path.startsWith(u+"/")&&s.push({tFile:r,wikilink:l}),s},[]);a.length===0?new g.Notice("Line does not contain any valid codes."):a.length===1?ae(e,n,a[0]):new j(t,e,n,a).open()}}var H=!1;async function se(t,e){if(!(e instanceof v.TFile)||!e.path.startsWith(u+"/")||H)return;if(t.vault.config.trashOption!=="local"){let o=`Code Files should be deleted via the "Delete Code Everywhere" command to ensure that references to it are correctly deleted as well.

Please restore the file and delete it again with that command, or set the trash location to "local" in your Obsidian config to have Quadroautomantically handle deletions.`;new v.Notice(o,15e3);return}let n=".trash/"+e.name;if(!await t.vault.adapter.exists(n)){let o=`Could not remove references to the Code File.

Please restore the file use the "Delete Code Everywhere" command.`;new v.Notice(o,7e3);return}await t.vault.adapter.rename(n,e.path),setTimeout(async()=>{H=!0,await ce(t,e),H=!1},1e3)}async function le(t){let e=T(t);if(!e)return;if(!h(t,"Codes")){new v.Notice("Must be in Code File to delete the code everywhere.");return}let n=e.editorComponent.view.file;ce(t,n)}async function ce(t,e){let o=(t.metadataCache.getFileCache(e)?.embeds||[]).map(l=>l.link).reduce((l,r)=>{let[c,d]=r.split("#");if(!c||!d)return l;let p=t.metadataCache.getFirstLinkpathDest(c,e.path);return p instanceof v.TFile&&l.push({file:p,blockId:d}),l},[]),i=[];for(let{file:l,blockId:r}of o){let c=await q(t,e,l,r);c&&i.push(c)}await t.vault.trash(e,!0);let a=o.length-i.length,s=`Code File "${e.basename}" and ${a} references to it deleted.
`;i.length>0&&(s+=`
\u26A0\uFE0F ${i.length} references could not be deleted:
- `+i.join(`
- `)),new v.Notice(s,(5+i.length)*1700)}var L=require("obsidian");function de(t){h(t,"Codes")?t.commands.executeCommandById("workspace:edit-file-title"):new L.Notice("You must be in a code file.")}function me(t){h(t,"Codes")?(t.internalPlugins.plugins["note-composer"]?.enable(),new L.Notice("Select a Code File from the list."),t.commands.executeCommandById("note-composer:merge-file")):new L.Notice("You must be in a code file.")}var ue=[{id:"assign-code",name:"Assign code to paragraph",func:ie,hotkeyLetter:"a",icon:"plus-circle"},{id:"rename-code",name:"Rename code",func:de,hotkeyLetter:"r",icon:"circle-slash"},{id:"unassign-code",name:"Delete code from paragraph",func:re,hotkeyLetter:"d",icon:"minus-circle"},{id:"delete-code-everywhere",name:"Delete code file and all references to it",func:le,icon:"x-circle"},{id:"merge-codes",name:"Merge codes",func:me,icon:"radius"},{id:"bulk-create-new-code-files",name:"Bulk create new code files",func:oe,icon:"circle-dashed"}];var F=require("obsidian");var X=class extends F.FuzzySuggestModal{constructor(e,n){super(e),this.extractionTypes=n,this.setPlaceholder("Select extraction type"),this.setInstructions(w),this.modalEl.addClass("quadro")}getItems(){return this.extractionTypes}getItemText(e){let n=e.children.length-1;return`${e.name} (${n})`}async onChooseItem(e){let n=this.app.vault.getFileByPath(`${e.path}/Template.md`);if(!n){new F.Notice(`ERROR: Could not find "Template.md" for Extraction Type "${e.name}".`,5e3);return}let o=this.app.metadataCache.getFileCache(n)?.frontmatter;if(!o){new F.Notice(`ERROR: Properties of "Template.md" for Extraction Type "${e.name}" are invalid.`,5e3);return}let i=Object.keys(o).map(p=>"	"+p.replaceAll(" ","-")+",");i.push("	extraction-source");let a=["```dataview","TABLE",...i,`FROM "${e.path}"`,'WHERE file.name != "Template"',"SORT extraction-date ASC","```","","---","","You can customize the table by modifying the Dataview Query: [Documentation of Dataview Queries](https://blacksmithgu.github.io/obsidian-dataview/queries/structure/)","","If you have the [Sortable](https://obsidian.md/plugins?id=obsidian-sortable) plugin installed, you can click on the header row of a column to sort the table by that column. (The plugin is pre-installed, if you use the Quadro Example Vault.)"].join(`
`),s=this.app.vault.getFolderByPath(f);if(s||(s=await this.app.vault.createFolder(M)),!s){new F.Notice("ERROR: Could not create Analysis Folder.",4e3);return}let l=e.name,r;for(;r=`${M}/${l}.md`,!!this.app.vault.getFileByPath(r);)l+="_1";let c=await this.app.vault.create(r,a);await this.app.workspace.getLeaf().openFile(c,G),this.app.commands.executeCommandById("file-explorer:reveal-active-file");let d=T(this.app);d&&d.setCursor(d.lastLine(),0)}};async function pe(t){if(![...t.plugins.enabledPlugins].includes("dataview")){if(!Object.keys(t.plugins.plugins).includes("dataview")){new F.Notice(`Plugin "Dataview" not installed.

Please install it from the Obsidian Community Store.`,7e3);return}if(!await t.plugins.enablePluginAndSave("dataview")){new F.Notice("ERROR: Dataview plugin could not be enabled.",4e3);return}}let n=t.vault.getFolderByPath(f);if(!n){new F.Notice("ERROR: Could not find Extraction Folder.",4e3);return}let o=n.children.filter(i=>i instanceof F.TFolder);if(o.length===0){new F.Notice("ERROR: Could not find any Extraction Types.",4e3);return}new X(t,o).open()}var C=require("obsidian");var Y=class extends C.Modal{constructor(n,o){super(n);this.nameOfNewType="";this.confirmationButton=null;this.onSubmit=o,this.modalEl.addClass("quadro")}onOpen(){let{contentEl:n}=this;n.createEl("h4",{text:"New Extraction Type"}),new C.Setting(n).setName("Name of the new type").addText(o=>o.onChange(i=>{this.nameOfNewType=i.trim(),this.confirmationButton?.setDisabled(this.nameOfNewType==="")})),new C.Setting(n).addButton(o=>{this.confirmationButton=o.setButtonText("Create").setCta().setDisabled(!0).onClick(()=>{this.close(),this.onSubmit(this.nameOfNewType)})}).addButton(o=>o.setButtonText("Cancel").onClick(()=>this.close()))}onClose(){let{contentEl:n}=this;n.empty()}};function V(t){new Y(t,async e=>{e=e.replace(/\.md$/,"").replaceAll("/","_").replace(/[:#^?!"*<>|[\]\\]/g,"-").replace(/^\./,"");let n=(0,C.normalizePath)(f+"/"+e);if(!(await t.vault.createFolder(n)instanceof C.TFolder)){new C.Notice("ERROR: Could not create Extraction Type Folder.",3e3);return}K(t,e)}).open()}async function K(t,e){new C.Notice(`Creating New Template for Extraction Type "${e}"`,6e3);let n=(0,C.normalizePath)(`${f}/${e}/Template.md`),i=await t.vault.create(n,`---
dimension: 
---

`);await R(t,i),t.commands.executeCommandById("file-explorer:reveal-active-file"),O("key")}function he(t){V(t)}var E=require("obsidian");var Q=class extends E.FuzzySuggestModal{constructor(e,n,o,i){super(e),this.extractionTypes=o,this.editor=n,this.dataFile=i,this.setPlaceholder("Select extraction type"),this.setInstructions(w),this.modalEl.addClass("quadro")}getItems(){return this.extractionTypes}getItemText(e){let n=e.children.find(a=>a instanceof E.TFile&&a.name==="Template.md"),o=e.children.length-1,i=n?`  (${o})`:'  [Select to create "Template.md"]';return e.name+i}onChooseItem(e){fe(this.editor,this.dataFile,e)}};async function fe(t,e,n){let o=t.editorComponent.app,i=n.name,a=n.path,s=o.vault.getFileByPath(`${a}/Template.md`);if(!s){K(o,i);return}let r=(await o.vault.cachedRead(s)).trim().split(`
`);if(!(r.filter(D=>D==="---").length===2)){new E.Notice(`The file "Template.md" in the folder "${a}" does not contain valid metadata fields.

You need to add valid fields before you can make extractions.`,6e3),R(o,s);return}let d,p=n.children.length-1;for(;p++,d=`${a}/${p}.md`,!!o.vault.getFileByPath(d););let y=t.getCursor(),$=t.getLine(y.line),{blockId:k,lineWithoutId:Te}=await S(e,$),Ee=`${Te} [[${i}/${p}]] ${k}`;t.setLine(y.line,Ee),t.setCursor(y);let we=`extraction date: ${new Date().toISOString().slice(0,-5)}`,xe=`extraction source: "[[${e.path}#${k}]]"`,ve=r.findLastIndex(D=>D==="---");r.splice(ve,0,we,xe),r.push("",`**Paragraph extracted from:** ![[${e.path}#${k}]]`);let ye=await o.vault.create(d,r.join(`
`));await R(o,ye),O("value")}async function ge(t){let e=T(t);if(!e||I(e))return;if(h(t,"Codes")||h(t,"Extractions")){new E.Notice("You must be in a Data File to make an extraction.",3e3);return}let n=t.vault.getFolderByPath(f);if(n||(n=await t.vault.createFolder(f)),!n){new E.Notice("ERROR: Could not create Extraction Folder.",4e3);return}let o=n.children.filter(a=>a instanceof E.TFolder),i=e.editorComponent.view.file;o.length===0?V(t):o.length===1&&o[0]?fe(e,i,o[0]):new Q(t,e,o,i).open()}var Ce=[{id:"extract-from-paragraph",name:"Extract from paragraph",func:ge,hotkeyLetter:"e",icon:"plus-square"},{id:"create-new-extraction-type",name:"Create new extraction type",func:he,icon:"box-select"},{id:"aggregate-extractions",name:"Aggregate extractions",func:pe,icon:"sigma-square"}];function P(t,e){let n=t.workspace.getActiveFile();if(!n){e.setText("");return}let o=[],i=t.metadataCache.resolvedLinks[n.path]||{};if(h(t,"Codes")){let r=0;for(let[c,d]of Object.entries(i))r+=d;o.push(`Code ${r}x assigned`)}else if(h(t,"Extractions")){let c=n.parent.children.length-1;o.push(`${c}x extracted`)}else{let r=0,c=0;for(let[d,p]of Object.entries(i))d.startsWith(u+"/")&&(r+=p),d.startsWith(f+"/")&&c++;r>0&&o.push(`${r} Codes`),c>0&&o.push(`${c} Extractions`)}let a=t.metadataCache.unresolvedLinks[n.path]||{},s=0;for(let[r,c]of Object.entries(a))s+=c;s>0&&o.push(`${s} invalid links`);let l=o.map(r=>r.replace(/^(1 .*)s$/,"$1")).join(", ");e.setText(l)}var N=class extends Fe.Plugin{constructor(){super(...arguments);this.statusbar=this.addStatusBarItem()}onload(){console.info(this.manifest.name+" Plugin loaded.");for(let n of[...ue,...Ce]){this.addRibbonIcon(n.icon,`Quadro: ${n.name}`,()=>n.func(this.app));let o={id:n.id,name:n.name,editorCallback:()=>n.func(this.app)};n.hotkeyLetter&&(o.hotkeys=[{modifiers:["Mod","Shift"],key:n.hotkeyLetter}]),this.addCommand(o)}P(this.app,this.statusbar),this.registerEvent(this.app.workspace.on("file-open",()=>P(this.app,this.statusbar))),this.registerEvent(this.app.metadataCache.on("resolved",()=>P(this.app,this.statusbar))),this.registerEvent(this.app.vault.on("delete",n=>se(this.app,n)))}onunload(){console.info(this.manifest.name+" Plugin unloaded.")}};
