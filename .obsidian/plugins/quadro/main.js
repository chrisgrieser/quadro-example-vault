/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var B=Object.defineProperty;var be=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames;var ke=Object.prototype.hasOwnProperty;var Se=(n,e)=>{for(var t in e)B(n,t,{get:e[t],enumerable:!0})},Re=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ae(e))!ke.call(n,i)&&i!==t&&B(n,i,{get:()=>e[i],enumerable:!(o=be(e,i))||o.enumerable});return n};var De=n=>Re(B({},"__esModule",{value:!0}),n);var Be={};Se(Be,{default:()=>P});module.exports=De(Be);var Te=require("obsidian");var E=require("obsidian");function Le(){return Math.ceil(Math.random()*1e6).toString().padStart(6,"0")}var _=/\^[\w-]+$/,Z=/^!\[\[(.+?)#(\^[\w-]+)\]\]$/,Oe=/\^[\w-]+(?=\n|$)/g;async function R(n,e){let[t]=e.match(_)||[];if(t){let r=e.slice(0,-t.length).trim();return{blockId:t,lineWithoutId:r}}let i=(await n.vault.cachedRead(n)).match(Oe)||[],a;do a="^id-"+Le();while(i.includes(a));return{blockId:a,lineWithoutId:e.trim()}}var u="Codes",ee={char:"\u{1FB0B}",charsPerBlock:100,maxLength:100},Pe={alphabeticalByCodeName:(n,e)=>n.basename.localeCompare(e.basename),alphabeticalByFullCode:(n,e)=>{let t=n.path.slice(u.length+1),o=e.path.slice(u.length+1);return t.localeCompare(o)},lastUsedFirst:(n,e)=>e.stat.mtime-n.stat.mtime,oldestUsedFirst:(n,e)=>n.stat.mtime-e.stat.mtime,frequentlyUsedFirst:(n,e)=>e.stat.size-n.stat.size,rarelyUsedFirst:(n,e)=>n.stat.size-e.stat.size,randomOrder:()=>Math.random()-.5},te=Pe.lastUsedFirst,C="Extractions",M="Analysis";var A=require("obsidian");function h(n,e){let t=e==="Codes"?u:C,o=n.workspace.getActiveFile();return o?!!o.path.startsWith(t+"/"):!1}function k(n){return n.path.slice(u.length+1,-3)}function w(n){let e=n.workspace.getActiveViewOfType(A.MarkdownView);return e?e.editor:(new A.Notice("No active editor."),null)}var x=[{command:"\u2191\u2193",purpose:"Navigate"},{command:"\u23CE",purpose:"Select"},{command:"esc",purpose:"Dismiss"}];function D(n){let e=`.workspace-leaf.mod-active .metadata-property:first-of-type .metadata-property-${n} :is([contenteditable='true'], input)`,t=document.querySelector(e);t instanceof HTMLElement&&Ne(t,0),t instanceof HTMLInputElement&&t.select()}function Ne(n,e){if(n instanceof HTMLInputElement){n.focus();let t=n.getAttribute("type")==="number";t&&n.setAttribute("type","text"),n.setSelectionRange(e,e),t&&n.setAttribute("type","number")}else{let t=document.createRange(),o=window.getSelection();t.setStart(n,e),t.collapse(!0),o?.removeAllRanges(),o?.addRange(t)}}var W={state:{source:!1,mode:"source"}};async function S(n,e){let t=n.workspace.getLeaf();await(n.workspace.getAdjacentLeafInDirection(t,"right")||n.workspace.createLeafBySplit(t,"vertical",!1)).openFile(e,W)}function I(n){let e=n.getCursor("head").line!==n.getCursor("anchor").line,t=n.listSelections().length>1;return e||t?(new A.Notice(`Paragraph not unambiguous since multiple lines are selected.

Unselect, move your cursor to the paragraph you want to affect, and use the command again.`,5e3),!0):!1}var m=require("obsidian");var U=class extends m.Modal{constructor(t,o){super(t);this.fullCode="";this.codeDesc="";this.confirmationButton=null;this.onSubmit=o,this.modalEl.addClass("quadro")}onOpen(){let{contentEl:t}=this;t.createEl("h4",{text:"New code creation"}),new m.Setting(t).setName("Name of the Code").setDesc('Use a slash ("/") in the name to create the Code File in a subfolder (group).').addText(o=>o.onChange(i=>{this.fullCode=i.trim(),this.confirmationButton?.setDisabled(this.fullCode==="")})),new m.Setting(t).setName("Code Description").setDesc('Will be added as metadata with the key "description".').addText(o=>o.onChange(i=>{this.codeDesc=i.trim()})),new m.Setting(t).addButton(o=>{this.confirmationButton=o.setButtonText("Create").setCta().setDisabled(!0).onClick(()=>{this.close(),this.onSubmit(this.fullCode,this.codeDesc)})}).addButton(o=>o.setButtonText("Cancel").onClick(()=>this.close()))}onClose(){let{contentEl:t}=this;t.empty()}},G=class extends m.Modal{constructor(t,o){super(t);this.input="";this.confirmationButton=null;this.onSubmit=o,this.modalEl.addClass("quadro")}onOpen(){let{contentEl:t}=this;t.createEl("h4",{text:"Bulk-create new codes"}),t.createEl("p",{text:"Every line will result in a new code file."}),t.createEl("p",{text:'Use a slash ("/") in the name to create the Code File in a subfolder (group).'}),new m.Setting(t).setClass("quadro-bulk-code-creation").addTextArea(o=>o.onChange(i=>{this.input=i.trim(),this.confirmationButton?.setDisabled(this.input==="")})),new m.Setting(t).addButton(o=>{this.confirmationButton=o.setButtonText("Create").setCta().setDisabled(!0).onClick(()=>{this.close(),this.onSubmit(this.input)})}).addButton(o=>o.setButtonText("Cancel").onClick(()=>this.close()))}onClose(){let{contentEl:t}=this;t.empty()}};async function ne(n,e,t){e=e.replace(/\.md$/,"").replace(/[:#^?!"*<>|[\]\\]/g,"-").replace(/^\.|\/\./g,"");let o=(0,m.normalizePath)(`${u}/${e}.md`);if(n.vault.getAbstractFileByPath(o)instanceof m.TFile)return new m.Notice(`Code "${e}" already exists, Code File not created.`),!1;let a=e.split("/"),r=a.pop(),l=a.length?"/"+a.join("/"):"",s=u+l;n.vault.getAbstractFileByPath(s)instanceof m.TFolder||await n.vault.createFolder(s),t=t.replaceAll('"',"'");let d=`---
description: "${t}"
---


---

`;return await n.vault.create(`${s}/${r}.md`,d)}function oe(n,e){new U(n,async(t,o)=>{let i=await ne(n,t,o);i?(new m.Notice(`Created new code file: "${t}"`),e(i)):new m.Notice("File creation failed.")}).open()}async function ie(n){new G(n,async e=>{let t=0,o=[];for(let a of e.split(`
`))await ne(n,a,"")?t++:o.push(a);let i=`${t} file(s) created`;o.length>0&&(i+=`
Could not create: `+o.join(", ")),new m.Notice(i,(o.length+2)*1e3)}).open()}var z=class extends E.FuzzySuggestModal{constructor(e,t,o,i){super(e),this.editor=t,this.codesInPara=o,this.dataFile=i,this.setPlaceholder("Select code to assign"),this.setInstructions([...x,{command:'type "new"',purpose:"Create new code"}]),this.modalEl.addClass("quadro")}getItems(){let e=this.app.vault.getMarkdownFiles().filter(t=>{let o=t.path.startsWith(u+"/"),i=this.codesInPara.find(a=>a.path===t.path);return o&&!i}).sort(te);return e.push("new-code-file"),e}getItemText(e){if(e==="new-code-file")return"\u{1F79C} Create new code";let{char:t,charsPerBlock:o,maxLength:i}=ee,a="    "+t.repeat(Math.min(i,e.stat.size/o));return k(e)+a}onChooseItem(e){e instanceof E.TFile?this.assignCode(e,this.dataFile):oe(this.app,t=>this.assignCode(t,this.dataFile))}async assignCode(e,t){let o=this.editor.getCursor(),i=k(e),a=this.editor.getLine(o.line),r=this.editor.getSelection();if(r){let y=r.replace(/^( ?)(.+?)( ?)$/g,"$1==$2==$3");this.editor.replaceSelection(y),a=this.editor.getLine(o.line)}let{blockId:l,lineWithoutId:s}=await R(t,a),c=`${s} [[${i}]] ${l}`;this.editor.setLine(o.line,c),this.editor.setCursor(o);let p=`![[${t.path.slice(0,-3)}#${l}]]
`;await this.app.vault.append(e,p)}};function ae(n){let e=w(n);if(!e||I(e))return;if(h(n,"Codes")||h(n,"Extractions")){new E.Notice("You must be in a Data File to assign a code.",3e3);return}if(e.getSelection().includes("==")){new E.Notice(`Selection contains highlights.
Overlapping highlights are not supported.`);return}let o=e.editorComponent.view.file,r=(e.getLine(e.getCursor().line).match(/\[\[.+?\]\]/g)||[]).reduce((l,s)=>{s=s.slice(2,-2);let c=n.metadataCache.getFirstLinkpathDest(s,o.path);return c instanceof E.TFile&&c.path.startsWith(u+"/")&&l.push(c),l},[]);new z(n,e,r,o).open()}var v=require("obsidian");var F=require("obsidian");var j=class extends F.FuzzySuggestModal{constructor(e,t,o,i){super(e),this.codesInParagraph=i,this.dataFile=o,this.editor=t,this.setPlaceholder("Select code to remove from paragraph"),this.setInstructions(x),this.modalEl.addClass("quadro")}getItems(){return this.codesInParagraph}getItemText(e){return k(e.tFile)}onChooseItem(e){se(this.editor,this.dataFile,e)}};async function q(n,e,t,o){let i=(await n.vault.read(t)).split(`
`),a=i.findIndex(c=>c.endsWith(o));if(a<0)return`Data File "${t.basename}", has no line with the ID "${o}".`;let r=i[a]||"",s=(r.match(/\[\[.+?\]\]/g)||[]).find(c=>{c=c.slice(2,-2);let d=n.metadataCache.getFirstLinkpathDest(c,t.path);return d instanceof F.TFile&&d.path===e.path});return s?(i[a]=r.replace(s,"").replace(/ {2,}/g," "),await n.vault.modify(t,i.join(`
`)),""):`Data File "${t.basename}", line "${o}" has no valid link to the Code File.`}async function se(n,e,t){let o=n.editorComponent.app,i=n.getCursor().line,a=n.getLine(i),r=new RegExp(" ?\\[\\["+t.wikilink+"\\]\\]");n.setLine(i,a.replace(r,""));let[l]=a.match(_)||[];if(!l){new F.Notice(`No ID found in current line.
Reference in Code File thus not deleted.`);return}let s=(await o.vault.read(t.tFile)).split(`
`),c=s.findIndex(d=>{if(!d.includes(l))return!1;let p=d.match(/\[\[.+?\]\]/g)||[];for(let y of p){let b=y.slice(2,-2).split("#")[0]||"";if(o.metadataCache.getFirstLinkpathDest(b,t.tFile.path)?.path===e.path)return!0}return!1});if(c<0){new F.Notice(`"Code File "${t.tFile.basename}" contains not reference to Data File "${e.basename}" with the ID "${l}". Reference in Code File is thus not deleted.`,7e3);return}s.splice(c,1),await o.vault.modify(t.tFile,s.join(`
`)),new F.Notice(`Assignment of code "${t.tFile.basename}" removed.`)}async function $e(n,e){let t=e.getLine(e.getCursor().line),[o,i,a]=t.match(Z)||[],r=e.editorComponent.view.file,l=n.metadataCache.getFirstLinkpathDest(i||"",r.path);if(!a||!i||!l){new F.Notice("Current line has no correct reference.");return}let s=await q(n,r,l,a);if(s){new F.Notice(s+`

Aborting removal of Code.`,4e3);return}n.commands.executeCommandById("editor:delete-paragraph"),e.setCursor({line:e.getCursor().line,ch:0}),new F.Notice(`Assignment of code "${r.basename}" removed.`)}async function re(n){let e=w(n);if(!(!e||I(e)))if(h(n,"Codes"))$e(n,e);else{let t=e.editorComponent.view.file,a=(e.getLine(e.getCursor().line).match(/\[\[.+?\]\]/g)||[]).reduce((r,l)=>{l=l.slice(2,-2);let s=n.metadataCache.getFirstLinkpathDest(l,t.path);return s instanceof F.TFile&&s.path.startsWith(u+"/")&&r.push({tFile:s,wikilink:l}),r},[]);a.length===0?new F.Notice("Line does not contain any valid codes."):a.length===1?se(e,t,a[0]):new j(n,e,t,a).open()}}var H=!1;async function le(n,e){if(!(e instanceof v.TFile)||!e.path.startsWith(u+"/")||H)return;if(n.vault.config.trashOption!=="local"){let o=`Code Files should be deleted via the "Delete Code Everywhere" command to ensure that references to it are correctly deleted as well.

Please restore the file and delete it again with that command, or set the trash location to "local" in your Obsidian config to have Quadroautomantically handle deletions.`;new v.Notice(o,15e3);return}let t=".trash/"+e.name;if(!await n.vault.adapter.exists(t)){let o=`Could not remove references to the Code File.

Please restore the file use the "Delete Code Everywhere" command.`;new v.Notice(o,7e3);return}await n.vault.adapter.rename(t,e.path),setTimeout(async()=>{H=!0,await de(n,e),H=!1},1e3)}async function ce(n){let e=w(n);if(!e)return;if(!h(n,"Codes")){new v.Notice("Must be in Code File to delete the code everywhere.");return}let t=e.editorComponent.view.file;de(n,t)}async function de(n,e){let o=(n.metadataCache.getFileCache(e)?.embeds||[]).map(l=>l.link).reduce((l,s)=>{let[c,d]=s.split("#");if(!c||!d)return l;let p=n.metadataCache.getFirstLinkpathDest(c,e.path);return p instanceof v.TFile&&l.push({file:p,blockId:d}),l},[]),i=[];for(let{file:l,blockId:s}of o){let c=await q(n,e,l,s);c&&i.push(c)}await n.vault.trash(e,!0);let a=o.length-i.length,r=`Code File "${e.basename}" and ${a} references to it deleted.
`;i.length>0&&(r+=`
\u26A0\uFE0F ${i.length} references could not be deleted:
- `+i.join(`
- `)),new v.Notice(r,(5+i.length)*1700)}var L=require("obsidian");function me(n){h(n,"Codes")?n.commands.executeCommandById("workspace:edit-file-title"):new L.Notice("You must be in a code file.")}function ue(n){h(n,"Codes")?(n.internalPlugins.plugins["note-composer"]?.enable(),new L.Notice("Select a Code File from the list."),n.commands.executeCommandById("note-composer:merge-file")):new L.Notice("You must be in a code file.")}var pe=[{id:"assign-code",name:"Assign code to paragraph",func:ae,hotkeyLetter:"a",icon:"plus-circle"},{id:"rename-code",name:"Rename code",func:me,hotkeyLetter:"r",icon:"circle-slash"},{id:"unassign-code",name:"Delete code from paragraph",func:re,hotkeyLetter:"d",icon:"minus-circle"},{id:"delete-code-everywhere",name:"Delete code file and all references to it",func:ce,icon:"x-circle"},{id:"merge-codes",name:"Merge codes",func:ue,icon:"radius"},{id:"bulk-create-new-code-files",name:"Bulk create new code files",func:ie,icon:"circle-dashed"}];var f=require("obsidian");var Y=class extends f.FuzzySuggestModal{constructor(e,t){super(e),this.extractionTypes=t,this.setPlaceholder("Select extraction type"),this.setInstructions(x),this.modalEl.addClass("quadro")}getItems(){return this.extractionTypes}getItemText(e){let t=e.children.length-1;return`${e.name} (${t})`}async onChooseItem(e){let t=this.app.vault.getAbstractFileByPath(`${e.path}/Template.md`);if(!(t instanceof f.TFile)){new f.Notice(`Error: Could not find "Template.md" for Extraction Type "${e.name}".`,4e3);return}let o=this.app.metadataCache.getFileCache(t)?.frontmatter;if(!o){new f.Notice(`Error: Could not read frontmatter from "Template.md" for Extraction Type "${e.name}".`,4e3);return}let i=Object.keys(o).map(p=>"	"+p.replaceAll(" ","-")+",");i.push("	extraction-source");let a=["```dataview","TABLE",...i,`FROM "${e.path}"`,'WHERE file.name != "Template"',"SORT extraction-date ASC","```","","---","","*Info: You can customize the table by modifying the Dataview Query:* [Documentation of Dataview Queries](https://blacksmithgu.github.io/obsidian-dataview/queries/structure/)"].join(`
`);this.app.vault.getAbstractFileByPath(C)instanceof f.TFolder||await this.app.vault.createFolder(M);let l=e.name,s;for(;s=`${M}/${l}.md`,this.app.vault.getAbstractFileByPath(s)instanceof f.TFile;)l+="_1";let c=await this.app.vault.create(s,a);await this.app.workspace.getLeaf().openFile(c,W),this.app.commands.executeCommandById("file-explorer:reveal-active-file");let d=w(this.app);d&&d.setCursor(d.lastLine(),0)}};async function he(n){if(![...n.plugins.enabledPlugins].includes("dataview")){if(!Object.keys(n.plugins.plugins).includes("dataview")){new f.Notice(`Plugin "Dataview" not installed.

Please install it from the Obsidian Community Store.`,7e3);return}if(!await n.plugins.enablePluginAndSave("dataview")){new f.Notice("ERROR: Dataview plugin could not be enabled.",4e3);return}}let t=n.vault.getAbstractFileByPath(C);if(!(t instanceof f.TFolder)){new f.Notice("ERROR: Could not find Extraction Folder.",3e3);return}let o=t.children.filter(i=>i instanceof f.TFolder);if(o.length===0){new f.Notice("ERROR: Could not find any Extraction Types.",3e3);return}new Y(n,o).open()}var T=require("obsidian");var V=class extends T.Modal{constructor(t,o){super(t);this.nameOfNewType="";this.confirmationButton=null;this.onSubmit=o,this.modalEl.addClass("quadro")}onOpen(){let{contentEl:t}=this;t.createEl("h4",{text:"New Extraction Type"}),new T.Setting(t).setName("Name of the new type").addText(o=>o.onChange(i=>{this.nameOfNewType=i.trim(),this.confirmationButton?.setDisabled(this.nameOfNewType==="")})),new T.Setting(t).addButton(o=>{this.confirmationButton=o.setButtonText("Create").setCta().setDisabled(!0).onClick(()=>{this.close(),this.onSubmit(this.nameOfNewType)})}).addButton(o=>o.setButtonText("Cancel").onClick(()=>this.close()))}onClose(){let{contentEl:t}=this;t.empty()}};function X(n){new V(n,async e=>{e=e.replace(/\.md$/,"").replaceAll("/","_").replace(/[:#^?!"*<>|[\]\\]/g,"-").replace(/^\./,"");let t=(0,T.normalizePath)(C+"/"+e);if(!(await n.vault.createFolder(t)instanceof T.TFolder)){new T.Notice("ERROR: Could not create Extraction Type Folder.",3e3);return}Q(n,e)}).open()}async function Q(n,e){new T.Notice(`Creating New Template for Extraction Type "${e}"`,6e3);let t=(0,T.normalizePath)(`${C}/${e}/Template.md`),i=await n.vault.create(t,`---
dimension: 
---

`);await S(n,i),n.commands.executeCommandById("file-explorer:reveal-active-file"),D("key")}function fe(n){X(n)}var g=require("obsidian");var J=class extends g.FuzzySuggestModal{constructor(e,t,o,i){super(e),this.extractionTypes=o,this.editor=t,this.dataFile=i,this.setPlaceholder("Select extraction type"),this.setInstructions(x),this.modalEl.addClass("quadro")}getItems(){return this.extractionTypes}getItemText(e){let t=e.children.find(a=>a instanceof g.TFile&&a.name==="Template.md"),o=e.children.length-1,i=t?`  (${o})`:'  [Select to create "Template.md"]';return e.name+i}onChooseItem(e){ge(this.editor,this.dataFile,e)}};async function ge(n,e,t){let o=n.editorComponent.app,i=t.name,a=t.path,r=o.vault.getAbstractFileByPath(`${a}/Template.md`);if(!(r instanceof g.TFile)){Q(o,i);return}let s=(await o.vault.cachedRead(r)).trim().split(`
`);if(!(s.filter($=>$==="---").length===2)){new g.Notice(`The file "Template.md" in the folder "${a}" does not contain valid metadata fields.

You need to add valid fields before you can make extractions.`,6e3),S(o,r);return}let d,p,y=t.children.length-1;do y++,p=`${a}/${y}.md`,d=o.vault.getAbstractFileByPath(p)instanceof g.TFile;while(d);let b=n.getCursor(),K=n.getLine(b.line),{blockId:N,lineWithoutId:we}=await R(e,K),xe=`${we} [[${i}/${y}]] ${N}`;n.setLine(b.line,xe),n.setCursor(b);let Ee=`extraction date: ${new Date().toISOString().slice(0,-5)}`,ve=`extraction source: "[[${e.path}#${N}]]"`,ye=s.findLastIndex($=>$==="---");s.splice(ye,0,Ee,ve),s.push("",`**Paragraph extracted from:** ![[${e.path}#${N}]]`);let Ie=await o.vault.create(p,s.join(`
`));await S(o,Ie),D("value")}async function Ce(n){let e=w(n);if(!e||I(e))return;if(h(n,"Codes")||h(n,"Extractions")){new g.Notice("You must be in a Data File to make an extraction.",3e3);return}let t=n.vault.getAbstractFileByPath(C);if(t instanceof g.TFolder||(t=await n.vault.createFolder(C)),!(t instanceof g.TFolder)){new g.Notice("ERROR: Could not create Extraction Folder.",3e3);return}let o=t.children.filter(a=>a instanceof g.TFolder),i=e.editorComponent.view.file;o.length===0?X(n):o.length===1&&o[0]?ge(e,i,o[0]):new J(n,e,o,i).open()}var Fe=[{id:"extract-from-paragraph",name:"Extract from paragraph",func:Ce,hotkeyLetter:"e",icon:"plus-square"},{id:"create-new-extraction-type",name:"Create new extraction type",func:fe,icon:"box-select"},{id:"aggregate-extractions",name:"Aggregate extractions",func:he,icon:"sigma-square"}];function O(n,e){let t=n.workspace.getActiveFile();if(!t){e.setText("");return}let o=[],i=n.metadataCache.resolvedLinks[t.path]||{};if(h(n,"Codes")){let s=0;for(let[c,d]of Object.entries(i))s+=d;o.push(`Code ${s}x assigned`)}else if(h(n,"Extractions")){let c=t.parent.children.length-1;o.push(`${c}x extracted`)}else{let s=0,c=0;for(let[d,p]of Object.entries(i))d.startsWith(u+"/")&&(s+=p),d.startsWith(C+"/")&&c++;s>0&&o.push(`${s} Codes`),c>0&&o.push(`${c} Extractions`)}let a=n.metadataCache.unresolvedLinks[t.path]||{},r=0;for(let[s,c]of Object.entries(a))r+=c;r>0&&o.push(`${r} invalid links`);let l=o.map(s=>s.replace(/^(1 .*)s$/,"$1")).join(", ");e.setText(l)}var P=class extends Te.Plugin{constructor(){super(...arguments);this.statusbar=this.addStatusBarItem()}onload(){console.info(this.manifest.name+" Plugin loaded.");for(let t of[...pe,...Fe]){this.addRibbonIcon(t.icon,`Quadro: ${t.name}`,()=>t.func(this.app));let o={id:t.id,name:t.name,editorCallback:()=>t.func(this.app)};t.hotkeyLetter&&(o.hotkeys=[{modifiers:["Mod","Shift"],key:t.hotkeyLetter}]),this.addCommand(o)}O(this.app,this.statusbar),this.registerEvent(this.app.workspace.on("file-open",()=>O(this.app,this.statusbar))),this.registerEvent(this.app.metadataCache.on("resolved",()=>O(this.app,this.statusbar))),this.registerEvent(this.app.vault.on("delete",t=>le(this.app,t)))}onunload(){console.info(this.manifest.name+" Plugin unloaded.")}};
